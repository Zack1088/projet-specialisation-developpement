import"./style-BpaiFPrc.js";const i="http://localhost:5000/api";let l="",c=null;function h(){return fetch(`${i}/csrf-token`,{credentials:"include"}).then(e=>e.json()).then(e=>l=e.csrfToken)}async function f(){try{const e=await fetch(`${i}/auth/me`,{credentials:"include"});if(e.status===401){c=null,u();return}if(!e.ok)throw new Error("Erreur lors de /me");const{id:t}=await e.json(),n=await fetch(`${i}/auth/profile/${t}`,{credentials:"include"});if(!n.ok)throw new Error("Erreur lors de /profile");c=await n.json()}catch(e){c=null,["Erreur lors de /me","Erreur lors de /profile"].includes(e.message)||console.warn("[fetchUserSession] ❌",e.message)}u()}function u(){const e=document.getElementById("navLinks"),t=document.getElementById("navUser"),n=document.getElementById("navUsername");c?(e==null||e.classList.add("hidden"),t==null||t.classList.remove("hidden"),n.textContent=`Bonjour ${c.username??c.name??"Utilisateur"}`):(e==null||e.classList.remove("hidden"),t==null||t.classList.add("hidden"),n.textContent="")}function m(){const e=document.getElementById("logoutBtn");e&&e.addEventListener("click",()=>{fetch(`${i}/auth/logout`,{credentials:"include"}).then(()=>{c=null,u(),d()})})}function p(){return fetch(`${i}/products`,{credentials:"include"}).then(e=>{if(!e.ok)throw new Error("Non autorisé");return e.json()}).then(E).catch(e=>{console.error("Erreur produits :",e),alert("Connexion requise pour voir les produits.")})}function E(e){const t=document.getElementById("search"),n=document.getElementById("products");function s(r){n.innerHTML="",r.forEach(o=>{const a=document.createElement("div");a.className="product bg-white p-4 rounded shadow",a.innerHTML=`
        <h3 class="font-bold text-lg">${o.name}</h3>
        <p class="text-sm text-gray-600">${o.description}</p>
        <p class="text-blue-600 font-semibold mt-2">${o.price} €</p>
        <button class="bg-blue-600 text-white px-3 py-1 mt-3 rounded hover:bg-blue-700 transition" data-id="${o.id}">
          Ajouter
        </button>
      `,n.appendChild(a)})}s(e),t.addEventListener("input",r=>{const o=r.target.value.toLowerCase();s(e.filter(a=>a.name.toLowerCase().includes(o)))}),n.addEventListener("click",r=>{if(r.target.tagName==="BUTTON"){const o=parseInt(r.target.getAttribute("data-id"),10);g(o)}})}function g(e){const t=!!c;return fetch(`${i}${t?"/cart":"/cart/session"}`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-CSRF-Token":l},body:JSON.stringify({...t&&{user_id:c.id},product_id:e,quantity:1})}).then(s=>{if(!s.ok)throw new Error("Erreur lors de l’ajout au panier");return s.json()}).then(()=>d()).catch(s=>{console.error("Ajout panier échoué :",s),alert("Impossible d'ajouter au panier.")})}function d(){const e=c?`/cart/${c.id}`:"/cart/session";return fetch(`${i}${e}`,{credentials:"include"}).then(t=>{if(!t.ok)throw new Error("Erreur panier");return t.json()}).then(({items:t,total:n})=>{const s=document.getElementById("cart");s.innerHTML="",t.forEach(r=>{const o=document.createElement("li");o.innerHTML=`
          ${r.name} x ${r.quantity} - ${r.price} €
          <button class="ml-2 text-red-600 hover:underline text-sm" data-id="${r.product_id}">Supprimer</button>
        `,s.appendChild(o)}),s.querySelectorAll("button[data-id]").forEach(r=>{r.addEventListener("click",()=>{const o=parseInt(r.getAttribute("data-id"),10);$(o)})}),document.getElementById("total").textContent=n.toFixed(2)}).catch(t=>{console.error("Erreur panier :",t)})}function $(e){const t=c?`/cart/${c.id}/${e}`:`/cart/session/${e}`;return fetch(`${i}${t}`,{method:"DELETE",credentials:"include",headers:{"X-CSRF-Token":l}}).then(n=>{if(!n.ok)throw new Error("Suppression échouée");return d()}).catch(n=>{console.error("Erreur suppression :",n)})}h().then(f).then(()=>{p(),d(),m()});
